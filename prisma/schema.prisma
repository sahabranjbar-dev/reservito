generator client {
  provider = "prisma-client-js"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  CUSTOMER
}

enum BusinessRole {
  OWNER
  STAFF
}

enum BookingStatus {
  AWAITING_PAYMENT //هنوز پرداخت نشده

  AWAITING_CONFIRMATION // پرداخت انجام شده، نیاز به تایید

  CONFIRMED //تایید شد، خدمت اجرا می‌شود

  REJECTED //مدیر تایید نکرد

  CANCELED //لغو شد

  COMPLETED // انجام شد

  NO_SHOW_CUSTOMER // مشتری نیامد

  NO_SHOW_STAFF // کارمند نیامد
}

enum PaymentMethod {
  ONLINE
  OFFLINE
}

enum PaymentStatus {
  UNPAID
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum BusinessType {
  SALON
  GYM
  CLINIC
  BEAUTY
  EDUCATION
  SPORTS
  CAFE
  RESTAURANT
  LAW
  DENTAL
  VETERINARY
  CONSULTING
  OTHER
}

enum WalletType {
  PLATFORM
  BUSINESS
}

enum LedgerEntryType {
  CREDIT
  DEBIT
}

enum SettlementStatus {
  PENDING
  PAID
  FAILED
}

enum BusinessRegistrationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum StaffServiceChangeStatus {
  PENDING
  APPROVED
  REJECTED
}

enum FinancialStatus {
  UNPAID
  PAID
  FINALIZED
}

model User {
  id               String            @id @default(cuid())

  phone            String            @unique
  email            String?           @unique
  username         String?           @unique
  passwordHash     String?

  fullName         String?
  avatar           String?

  isActive         Boolean           @default(true)
  lastLoginAt      DateTime?
  createdAt        DateTime          @default(now())
  deletedAt        DateTime?

  roles            UserRole[]
  favorites        Favorite[]

  businessMembers  BusinessMember[]
  ownedBusinesses  Business[]

  bookings         Booking[]
  createdBookings  Booking[]        @relation("BookingCreatedBy")

  verifiedPayments Payment[]        @relation("PaymentVerifiedBy")

  staffMembers     StaffMember[]

  discountUsages   DiscountUsage[]
}

model UserRole {
  id     String  @id @default(cuid())
  userId String
  role   Role

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
}

model Business {
  id                  String                      @id @default(cuid())
  slug                String                      @unique

  businessName        String
  ownerName           String

  description         String?                     @db.Text
  logo                String?
  banner              String?

  address             String?                     @db.Text
  latitude            Float?
  longitude           Float?

  timezone            String                      @default("Asia/Tehran")

  allowOnlinePayment  Boolean                     @default(true)
  allowOfflinePayment Boolean                     @default(false)

  commissionRate      Int                         @default(10)

  ownerId             String
  owner               User                       @relation(fields: [ownerId], references: [id])

  identifier          String                      @unique

  registrationStatus  BusinessRegistrationStatus  @default(PENDING)
  rejectionReason     String?
  isActive            Boolean                     @default(true)

  activatedAt         DateTime?
  rejectedAt          DateTime?

  businessType        BusinessType                @default(OTHER)

  createdAt           DateTime                    @default(now())
  updatedAt           DateTime                    @updatedAt
  deletedAt           DateTime?

  favorites           Favorite[]
  businessMembers     BusinessMember[]

  staffMembers        StaffMember[]
  services            Service[]

  bookings            Booking[]
  payments            Payment[]
  settlements         Settlement[]
  ledgerEntries       LedgerEntry[]
  discounts           Discount[]

  commissions         Commission[]
}

model BusinessMember {
  id         String        @id @default(cuid())
  userId     String
  businessId String
  role       BusinessRole

  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  business   Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([userId, businessId])
}

model StaffMember {
  id                    String                       @id @default(cuid())

  businessId            String
  business              Business                    @relation(fields: [businessId], references: [id], onDelete: Cascade)

  userId                String?
  user                  User?                       @relation(fields: [userId], references: [id])

  name                  String
  avatar                String?
  phone                 String?

  isActive              Boolean                      @default(true)

  createdAt             DateTime                     @default(now())
  updatedAt             DateTime                     @updatedAt
  deletedAt             DateTime?

  schedules             StaffAvailability[]
  exceptions            StaffException[]
  services              ServiceStaff[]
  bookings              Booking[]

  serviceChangeRequests StaffServiceChangeRequest[]

  @@unique([businessId, userId])
}

model StaffAvailability {
  id        String       @id @default(cuid())

  staffId   String
  staff     StaffMember @relation(fields: [staffId], references: [id], onDelete: Cascade)

  dayOfWeek Int
  startTime String
  endTime   String
  isClosed  Boolean      @default(false)

  @@unique([staffId, dayOfWeek])
}

model StaffException {
  id        String       @id @default(cuid())

  staffId   String
  staff     StaffMember @relation(fields: [staffId], references: [id], onDelete: Cascade)

  date      DateTime     @db.Date
  isClosed  Boolean      @default(true)

  startTime String?
  endTime   String?
  reason    String?

  @@unique([staffId, date])
}

model Service {
  id                  String                       @id @default(cuid())
  name                String
  description         String?                      @db.Text

  price               Int
  duration            Int
  capacity            Int                          @default(1)

  depositRequired     Boolean                      @default(false)
  depositAmount       Int?

  isActive            Boolean                      @default(true)

  businessId          String
  business            Business                    @relation(fields: [businessId], references: [id], onDelete: Cascade)

  staff               ServiceStaff[]
  bookings            Booking[]

  staffChangeRequests StaffServiceChangeRequest[]
}

model ServiceStaff {
  id            String       @id @default(cuid())

  serviceId     String
  service       Service     @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  staffId       String
  staff         StaffMember @relation(fields: [staffId], references: [id], onDelete: Cascade)

  overridePrice Int?

  @@unique([serviceId, staffId])
}

model Booking {
  id              String           @id @default(cuid())

  businessId      String
  business        Business        @relation(fields: [businessId], references: [id])

  customerId      String
  customer        User            @relation(fields: [customerId], references: [id])

  serviceId       String
  service         Service         @relation(fields: [serviceId], references: [id])

  staffId         String
  staff           StaffMember     @relation(fields: [staffId], references: [id])

  startTime       DateTime
  endTime         DateTime

  status          BookingStatus    @default(AWAITING_PAYMENT)
  totalPrice      Int

  finalPrice      Int
  penaltyAmount   Int              @default(0)
  financialStatus FinancialStatus  @default(UNPAID)
  customerNotes   String?
  internalNotes   String?

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  deletedAt       DateTime?

  createdById     String?
  createdBy       User?           @relation("BookingCreatedBy", fields: [createdById], references: [id])

  payments        Payment[]
  discountUsages  DiscountUsage[]

  commission      Commission?
}

model Payment {
  id             String           @id @default(cuid())

  businessId     String
  business       Business        @relation(fields: [businessId], references: [id])

  bookingId      String
  booking        Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  method         PaymentMethod    @default(ONLINE)
  amount         Int
  status         PaymentStatus    @default(PENDING)

  authority      String?
  refId          String?
  gatewayName    String?

  verifiedById   String?
  verifiedBy     User?           @relation("PaymentVerifiedBy", fields: [verifiedById], references: [id])
  verifiedAt     DateTime?

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  discountUsages DiscountUsage[]
  ledgerEntries  LedgerEntry[]
}

model Commission {
  id            String     @id @default(cuid())
  bookingId     String     @unique
  booking       Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  businessId    String
  business      Business  @relation(fields: [businessId], references: [id])
  grossAmount   Int
  platformFee   Int
  businessShare Int
  isSettled     Boolean    @default(false)
  settledAt     DateTime?
  createdAt     DateTime   @default(now())
}

model LedgerEntry {
  id           String           @id @default(cuid())
  walletType   WalletType
  entryType    LedgerEntryType
  amount       Int
  paymentId    String?
  payment      Payment?        @relation(fields: [paymentId], references: [id])
  settlementId String?
  settlement   Settlement?     @relation(fields: [settlementId], references: [id])
  businessId   String?
  business     Business?       @relation(fields: [businessId], references: [id])
  createdAt    DateTime         @default(now())
}

model Settlement {
  id            String            @id @default(cuid())
  businessId    String
  business      Business         @relation(fields: [businessId], references: [id])
  amount        Int
  status        SettlementStatus  @default(PENDING)
  fromDate      DateTime
  toDate        DateTime
  paidAt        DateTime?
  createdAt     DateTime          @default(now())

  ledgerEntries LedgerEntry[]
}

model OtpCode {
  phone     String    @id
  codeHash  String
  expiresAt DateTime

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Favorite {
  id         String    @id @default(cuid())

  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt  DateTime  @default(now())

  @@unique([userId, businessId])
}

model StaffServiceChangeRequest {
  id                   String                    @id @default(cuid())
  staffId              String
  staff                StaffMember              @relation(fields: [staffId], references: [id])
  serviceId            String
  service              Service                  @relation(fields: [serviceId], references: [id])
  requestedPrice       Int?
  requestedActive      Boolean?
  requestedName        String?
  requestedDescription String?                   @db.Text
  requestedDuration    Int?
  status               StaffServiceChangeStatus  @default(PENDING)
  rejectionReason      String?
  createdAt            DateTime                  @default(now())
  reviewedAt           DateTime?
}

enum DiscountType {
  PERCENT
  FIXED
}

enum DiscountScope {
  PLATFORM
  BUSINESS
}

enum DiscountStatus {
  ACTIVE
  INACTIVE
  EXPIRED
}

enum DiscountUsageStatus {
  RESERVED
  CONFIRMED
  CANCELED

}

model Discount {
  id             String           @id @default(cuid())
  code           String           @unique
  type           DiscountType
  value          Int
  scope          DiscountScope    @default(PLATFORM)
  businessId     String?
  business       Business?       @relation(fields: [businessId], references: [id])
  maxDiscount    Int?
  minOrderAmount Int?
  usageLimit     Int?
  usedCount      Int              @default(0)
  perUserLimit   Int?
  startsAt       DateTime
  expiresAt      DateTime
  status         DiscountStatus   @default(ACTIVE)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  usages         DiscountUsage[]
}

model DiscountUsage {
  id                  String               @id @default(cuid())

  discountId          String
  discount            Discount            @relation(fields: [discountId], references: [id])

  userId              String
  user                User                @relation(fields: [userId], references: [id])

  bookingId           String
  booking             Booking             @relation(fields: [bookingId], references: [id])

  paymentId           String?
  payment             Payment?            @relation(fields: [paymentId], references: [id])

  discountAmount      Int

  usedAt              DateTime             @default(now())

  disCountUsageStatus DiscountUsageStatus  @default(RESERVED)

  @@unique([discountId, userId, bookingId])
}
