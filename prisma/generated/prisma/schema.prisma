generator client {
  provider = "prisma-client-js"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// ENUMS
// ==========================================

/// نقش‌های سطح سیستم
enum Role {
  SUPER_ADMIN
  BUSINESS_OWNER
  STAFF
  CUSTOMER
}

enum BookingStatus {
  PENDING_CONFIRMATION
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum PaymentMethod {
  ONLINE
  OFFLINE
}

enum PaymentStatus {
  UNPAID
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum BusinessType {
  SALON
  GYM
  CLINIC
  BEAUTY
  EDUCATION
  SPORTS
  CAFE
  RESTAURANT
  LAW
  DENTAL
  VETERINARY
  CONSULTING
  OTHER
}

enum WalletType {
  PLATFORM
  BUSINESS
}

enum LedgerEntryType {
  CREDIT // بستانکار
  DEBIT // بدهکار
}

enum SettlementStatus {
  PENDING
  PAID
  FAILED
}

// ==========================================
// USERS & AUTH
// ==========================================

model User {
  id String @id @default(cuid())

  /// شماره موبایل (شناسه اصلی OTP)
  phone String @unique

  /// ایمیل اختیاری (ادمین / بیزنس)
  email String? @unique

  /// فقط برای لاگین بیزنس / ادمین
  username     String? @unique
  passwordHash String?

  fullName String?
  avatar   String?

  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  deletedAt   DateTime?

  // ================= Relations =================

  favorites Favorite[]
  /// نقش‌های کاربر (چندگانه)
  roles     UserRole[]

  /// بیزنس‌هایی که مالک آن است
  ownedBusinesses Business[]

  /// رزروهایی که به عنوان مشتری انجام داده
  bookings Booking[]

  /// رزروهایی که ثبت کرده (منشی / ادمین)
  createdBookings Booking[] @relation("BookingCreatedBy")

  /// پرداخت‌هایی که تأیید کرده
  verifiedPayments Payment[] @relation("PaymentVerifiedBy")

  /// عضویت در بیزنس‌ها به عنوان پرسنل
  staffMembers StaffMember[]
}

/// جدول واسط نقش‌ها (خیلی مهم)
model UserRole {
  id     String @id @default(cuid())
  userId String
  role   Role

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
}

// ==========================================
// BUSINESS
// ==========================================

model Business {
  id   String @id @default(cuid())
  slug String @unique

  businessName String
  ownerName    String

  description String? @db.Text
  logo        String?
  banner      String?

  address   String? @db.Text
  latitude  Float?
  longitude Float?

  timezone String @default("Asia/Tehran")

  allowOnlinePayment  Boolean @default(true)
  allowOfflinePayment Boolean @default(false)

  commissionRate Int @default(10)

  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id])

  identifier String  @unique
  isActive   Boolean @default(true)

  favorites Favorite[]

  businessType BusinessType @default(OTHER)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // ================= Relations =================

  bookings      Booking[]
  payments      Payment[]
  settlements   Settlement[]
  ledgerEntries LedgerEntry[]

  // ✅ این دوتا مهم بودن
  staffMembers StaffMember[]
  services     Service[]
}

// ==========================================
// STAFF & SCHEDULING
// ==========================================

model StaffMember {
  id String @id @default(cuid())

  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  /// اگر پرسنل اکانت داشته باشد
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  /// نام نمایشی
  name   String
  avatar String?
  phone  String?

  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  schedules  StaffAvailability[]
  exceptions StaffException[]
  services   ServiceStaff[]
  bookings   Booking[]

  /// یک یوزر فقط یک‌بار در هر بیزنس
  @@unique([businessId, userId])
  @@index([businessId])
  @@index([userId])
}

model StaffAvailability {
  id String @id @default(cuid())

  staffId String
  staff   StaffMember @relation(fields: [staffId], references: [id], onDelete: Cascade)

  /// 0 = شنبه ، 6 = جمعه
  dayOfWeek Int

  startTime String // "09:00"
  endTime   String // "17:00"

  isClosed Boolean @default(false)

  @@unique([staffId, dayOfWeek])
}

model StaffException {
  id String @id @default(cuid())

  staffId String
  staff   StaffMember @relation(fields: [staffId], references: [id], onDelete: Cascade)

  /// تعطیلی خاص
  date     DateTime @db.Date
  isClosed Boolean  @default(true)

  @@unique([staffId, date])
}

// ==========================================
// SERVICES
// ==========================================

model Service {
  id          String  @id @default(cuid())
  name        String
  description String? @db.Text

  price    Int
  duration Int // دقیقه
  capacity Int @default(1)

  depositRequired Boolean @default(false)
  depositAmount   Int?

  isActive Boolean @default(true)

  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  staff    ServiceStaff[]
  bookings Booking[]

  @@index([businessId])
}

model ServiceStaff {
  id String @id @default(cuid())

  serviceId String
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  staffId String
  staff   StaffMember @relation(fields: [staffId], references: [id], onDelete: Cascade)

  /// قیمت اختصاصی
  overridePrice Int?

  @@unique([serviceId, staffId])
}

// ==========================================
// BOOKINGS & PAYMENTS
// ==========================================

model Booking {
  id String @id @default(cuid())

  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  /// مشتری (OTP)
  customerId String
  customer   User   @relation(fields: [customerId], references: [id])

  serviceId String
  service   Service @relation(fields: [serviceId], references: [id])

  staffId String
  staff   StaffMember @relation(fields: [staffId], references: [id])

  startTime DateTime
  endTime   DateTime

  status     BookingStatus @default(PENDING_CONFIRMATION)
  totalPrice Int

  customerNotes String? @db.Text
  internalNotes String? @db.Text

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  /// ثبت‌کننده رزرو
  createdById String?
  createdBy   User?   @relation("BookingCreatedBy", fields: [createdById], references: [id])

  payments Payment[]

  @@index([businessId, startTime])
  @@index([staffId])
  @@index([customerId])
}

model Payment {
  id String @id @default(cuid())

  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  bookingId String  @unique
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  method PaymentMethod @default(ONLINE)

  amount Int
  status PaymentStatus @default(PENDING)

  authority   String?
  refId       String?
  gatewayName String?

  verifiedById String?
  verifiedBy   User?     @relation("PaymentVerifiedBy", fields: [verifiedById], references: [id])
  verifiedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ///           Relations
  ledgerEntries LedgerEntry[]
  commission    Commission?

  @@index([businessId])
}

model Commission {
  id String @id @default(cuid())

  paymentId String  @unique
  payment   Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  grossAmount   Int // مبلغ پرداختی مشتری
  platformFee   Int // سهم پلتفرم
  businessShare Int // سهم بیزنس
  taxAmount     Int? // مالیات (اختیاری – آینده)

  createdAt DateTime @default(now())
}

model LedgerEntry {
  id String @id @default(cuid())

  walletType WalletType
  entryType  LedgerEntryType

  amount Int

  /// برای ردیابی
  paymentId String?
  payment   Payment? @relation(fields: [paymentId], references: [id])

  settlementId String?
  settlement   Settlement? @relation(fields: [settlementId], references: [id])

  businessId String?
  business   Business? @relation(fields: [businessId], references: [id])

  createdAt DateTime @default(now())

  @@index([walletType])
  @@index([businessId])
}

// (تسویه دوره‌ای)
model Settlement {
  id String @id @default(cuid())

  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  amount Int
  status SettlementStatus @default(PENDING)

  fromDate DateTime
  toDate   DateTime

  paidAt    DateTime?
  createdAt DateTime  @default(now())

  ledgerEntries LedgerEntry[]

  @@index([businessId, status])
}

// ==========================================
// OTP
// ==========================================

/// فقط برای لاگین OTP مشتریان
model OtpCode {
  phone     String   @id
  codeHash  String
  expiresAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([expiresAt])
}

model Favorite {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  // جلوگیری از علاقه تکراری برای یک کاربر
  @@unique([userId, businessId])
}
