generator client {
  output   = "./generated/prisma"
  provider      = "prisma-client"
  binaryTargets = ["native", "debian-openssl-3.0.x", "windows"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  CUSTOMER
}

enum BusinessRole {
  OWNER
  STAFF
}

enum BookingStatus {
  PENDING // در انتظار تائید

  CONFIRMED //تایید شد، خدمت اجرا می‌شود

  REJECTED //مدیر تایید نکرد

  CANCELED //لغو شد

  COMPLETED // انجام شد

  NO_SHOW_CUSTOMER // مشتری نیامد

  NO_SHOW_STAFF // کارمند نیامد
}

enum BusinessType {
  SALON
  GYM
  CLINIC
  BEAUTY
  EDUCATION
  SPORTS
  CAFE
  RESTAURANT
  LAW
  DENTAL
  VETERINARY
  CONSULTING
  OTHER
}

enum BusinessRegistrationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum StaffServiceChangeStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id              String                 @id @default(cuid())

  phone           String                 @unique

  email           String?                @unique
  username        String?                @unique
  passwordHash    String?

  fullName        String?
  avatar          String?

  isActive        Boolean                @default(true)
  lastLoginAt     DateTime?
  createdAt       DateTime               @default(now())
  deletedAt       DateTime?

  roles           UserRole[]
  favorites       Favorite[]

  businessMembers BusinessMember[]
  ownedBusinesses Business[]

  bookings        Booking[]
  createdBookings Booking[]             @relation("BookingCreatedBy")

  staffMembers    StaffMember[]

  notifications   Notification[]
  tickets         Ticket[]
  contactReplies  ContactMessageReply[]
  auditLogs       AuditLog[]
}

model UserRole {
  id     String  @id @default(cuid())
  userId String
  role   Role

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
}

model Business {
  id                 String                      @id @default(cuid())
  slug               String                      @unique

  businessName       String
  ownerName          String

  description        String?                     @db.Text
  logo               String?
  banner             String?

  address            String?                     @db.Text

  ownerId            String
  owner              User                       @relation(fields: [ownerId], references: [id])

  identifier         String                      @unique

  registrationStatus BusinessRegistrationStatus  @default(PENDING)
  rejectionReason    String?
  isActive           Boolean                     @default(true)

  activatedAt        DateTime?
  rejectedAt         DateTime?

  businessType       BusinessType                @default(OTHER)

  createdAt          DateTime                    @default(now())
  updatedAt          DateTime                    @updatedAt
  deletedAt          DateTime?

  favorites          Favorite[]
  businessMembers    BusinessMember[]

  staffMembers       StaffMember[]
  services           Service[]

  bookings           Booking[]
}

model BusinessMember {
  id         String        @id @default(cuid())
  userId     String
  businessId String
  role       BusinessRole

  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  business   Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([userId, businessId])
}

model StaffMember {
  id                    String                       @id @default(cuid())

  businessId            String
  business              Business                    @relation(fields: [businessId], references: [id], onDelete: Cascade)

  userId                String?
  user                  User?                       @relation(fields: [userId], references: [id])

  name                  String
  avatar                String?
  phone                 String?

  breakMinutes          Int                          @default(0)

  isActive              Boolean                      @default(true)

  createdAt             DateTime                     @default(now())
  updatedAt             DateTime                     @updatedAt
  deletedAt             DateTime?

  schedules             StaffAvailability[]
  exceptions            StaffException[]
  services              ServiceStaff[]
  bookings              Booking[]

  serviceChangeRequests StaffServiceChangeRequest[]

  @@unique([businessId, userId])
}

model StaffAvailability {
  id        String       @id @default(cuid())

  staffId   String
  staff     StaffMember @relation(fields: [staffId], references: [id], onDelete: Cascade)

  dayOfWeek Int
  startTime String
  endTime   String
  isClosed  Boolean      @default(false)

  @@unique([staffId, dayOfWeek])
}

model StaffException {
  id        String       @id @default(cuid())

  staffId   String
  staff     StaffMember @relation(fields: [staffId], references: [id], onDelete: Cascade)

  date      DateTime     @db.Date
  isClosed  Boolean      @default(true)

  startTime String?
  endTime   String?
  reason    String?

  @@unique([staffId, date])
}

model Service {
  id                  String                       @id @default(cuid())
  name                String
  description         String?                      @db.Text

  price               Int?
  duration            Int
  capacity            Int                          @default(1)

  isActive            Boolean                      @default(true)

  businessId          String
  business            Business                    @relation(fields: [businessId], references: [id], onDelete: Cascade)

  staff               ServiceStaff[]
  bookings            Booking[]

  staffChangeRequests StaffServiceChangeRequest[]

  createdAt           DateTime                     @default(now())
  updatedAt           DateTime                     @updatedAt
  deletedAt           DateTime?
}

model ServiceStaff {
  id            String       @id @default(cuid())

  serviceId     String
  service       Service     @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  staffId       String
  staff         StaffMember @relation(fields: [staffId], references: [id], onDelete: Cascade)

  overridePrice Int?

  @@unique([serviceId, staffId])
}

model Booking {
  id            String         @id @default(cuid())

  businessId    String
  business      Business      @relation(fields: [businessId], references: [id])

  customerId    String
  customer      User          @relation(fields: [customerId], references: [id])

  serviceId     String
  service       Service       @relation(fields: [serviceId], references: [id])

  staffId       String
  staff         StaffMember   @relation(fields: [staffId], references: [id])

  startTime     DateTime
  endTime       DateTime

  status        BookingStatus  @default(PENDING)

  customerNotes String?
  internalNotes String?

  canceledAt    DateTime?
  cancelReason  String?

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  deletedAt     DateTime?

  createdById   String?
  createdBy     User?         @relation("BookingCreatedBy", fields: [createdById], references: [id])

  @@index([serviceId, startTime])
  @@index([staffId, startTime])
  @@index([businessId, startTime])
  @@index([status])
}

model Favorite {
  id         String    @id @default(cuid())

  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt  DateTime  @default(now())

  @@unique([userId, businessId])
}

model StaffServiceChangeRequest {
  id                   String                    @id @default(cuid())
  staffId              String
  staff                StaffMember              @relation(fields: [staffId], references: [id])
  serviceId            String
  service              Service                  @relation(fields: [serviceId], references: [id])
  requestedPrice       Int?
  requestedActive      Boolean?
  requestedName        String?
  requestedDescription String?                   @db.Text
  requestedDuration    Int?
  status               StaffServiceChangeStatus  @default(PENDING)
  rejectionReason      String?
  createdAt            DateTime                  @default(now())
  reviewedAt           DateTime?
}

model OtpCode {
  phone     String    @id
  codeHash  String
  expiresAt DateTime

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

enum ContactMessageStatus {
  NEW
  REPLIED
  CLOSED
}

model ContactMessage {
  id                  String                 @id @default(cuid())

  fullName            String
  email               String?
  phone               String
  message             String

  status              ContactMessageStatus   @default(NEW)

  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  ContactMessageReply ContactMessageReply[]
}

model AuditLog {
  id          String    @id @default(cuid())
  action      String
  entityType  String
  entityId    String
  performedBy String?
  metadata    Json?
  createdAt   DateTime  @default(now())

  user        User?    @relation(fields: [performedBy], references: [id])
}

enum NotificationType {
  SYSTEM
  BOOKING
  MESSAGE
  SERVICE_CHANGE
}

model Notification {
  id        String            @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  body      String
  isRead    Boolean           @default(false)
  createdAt DateTime          @default(now())

  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ContactMessageReply {
  id        String          @id @default(cuid())
  messageId String
  message   ContactMessage @relation(fields: [messageId], references: [id])

  reply     String
  repliedBy String?
  createdAt DateTime        @default(now())

  user      User?          @relation(fields: [repliedBy], references: [id])
}

enum TicketStatus {
  OPEN
  PENDING
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
}

model Ticket {
  id          String           @id @default(cuid())
  userId      String
  subject     String
  description String?          @db.Text
  status      TicketStatus     @default(OPEN)
  priority    TicketPriority   @default(MEDIUM)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  closedAt    DateTime?

  user        User            @relation(fields: [userId], references: [id])
  messages    TicketMessage[]
}

model TicketMessage {
  id        String    @id @default(cuid())
  ticketId  String
  content   String    @db.Text
  isAdmin   Boolean   @default(false)
  senderId  String?
  createdAt DateTime  @default(now())

  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
}
