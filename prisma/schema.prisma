generator client {
  provider = "prisma-client-js"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* =======================
   ENUMS
======================= */

enum Role {
  SUPER_ADMIN
  CUSTOMER
}

enum BusinessRole {
  OWNER
  STAFF
}

enum BookingStatus {
  PENDING_CONFIRMATION
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum PaymentMethod {
  ONLINE
  OFFLINE
}

enum PaymentStatus {
  UNPAID
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum BusinessType {
  SALON
  GYM
  CLINIC
  BEAUTY
  EDUCATION
  SPORTS
  CAFE
  RESTAURANT
  LAW
  DENTAL
  VETERINARY
  CONSULTING
  OTHER
}

enum WalletType {
  PLATFORM
  BUSINESS
}

enum LedgerEntryType {
  CREDIT
  DEBIT
}

enum SettlementStatus {
  PENDING
  PAID
  FAILED
}

enum BusinessRegistrationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum StaffServiceChangeStatus {
  PENDING
  APPROVED
  REJECTED
}

/* =======================
   USER & AUTH
======================= */

model User {
  id               String            @id @default(cuid())

  phone            String            @unique
  email            String?           @unique
  username         String?           @unique
  passwordHash     String?

  fullName         String?
  avatar           String?

  isActive         Boolean           @default(true)
  lastLoginAt      DateTime?
  createdAt        DateTime          @default(now())
  deletedAt        DateTime?

  roles            UserRole[]
  favorites        Favorite[]

  businessMembers  BusinessMember[]
  ownedBusinesses  Business[]

  bookings         Booking[]
  createdBookings  Booking[]        @relation("BookingCreatedBy")

  verifiedPayments Payment[]        @relation("PaymentVerifiedBy")

  staffMembers     StaffMember[]
}

model UserRole {
  id     String  @id @default(cuid())
  userId String
  role   Role

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
}

/* =======================
   BUSINESS
======================= */

model Business {
  id                  String                      @id @default(cuid())
  slug                String                      @unique

  businessName        String
  ownerName           String

  description         String?                     @db.Text
  logo                String?
  banner              String?

  address             String?                     @db.Text
  latitude            Float?
  longitude           Float?

  timezone            String                      @default("Asia/Tehran")

  allowOnlinePayment  Boolean                     @default(true)
  allowOfflinePayment Boolean                     @default(false)

  commissionRate      Int                         @default(10)

  ownerId             String
  owner               User                       @relation(fields: [ownerId], references: [id])

  identifier          String                      @unique

  registrationStatus  BusinessRegistrationStatus  @default(PENDING)
  rejectionReason     String?
  isActive            Boolean                     @default(true)

  activatedAt         DateTime?
  rejectedAt          DateTime?

  businessType        BusinessType                @default(OTHER)

  createdAt           DateTime                    @default(now())
  updatedAt           DateTime                    @updatedAt
  deletedAt           DateTime?

  favorites           Favorite[]
  businessMembers     BusinessMember[]

  staffMembers        StaffMember[]
  services            Service[]

  bookings            Booking[]
  payments            Payment[]
  settlements         Settlement[]
  ledgerEntries       LedgerEntry[]
}

model BusinessMember {
  id         String        @id @default(cuid())
  userId     String
  businessId String
  role       BusinessRole

  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  business   Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([userId, businessId])
}

/* =======================
   STAFF
======================= */

model StaffMember {
  id                    String                       @id @default(cuid())

  businessId            String
  business              Business                    @relation(fields: [businessId], references: [id], onDelete: Cascade)

  userId                String?
  user                  User?                       @relation(fields: [userId], references: [id])

  name                  String
  avatar                String?
  phone                 String?

  isActive              Boolean                      @default(true)

  createdAt             DateTime                     @default(now())
  updatedAt             DateTime                     @updatedAt
  deletedAt             DateTime?

  schedules             StaffAvailability[]
  exceptions            StaffException[]
  services              ServiceStaff[]
  bookings              Booking[]

  serviceChangeRequests StaffServiceChangeRequest[]

  @@unique([businessId, userId])
}

model StaffAvailability {
  id        String       @id @default(cuid())

  staffId   String
  staff     StaffMember @relation(fields: [staffId], references: [id], onDelete: Cascade)

  dayOfWeek Int
  startTime String
  endTime   String
  isClosed  Boolean      @default(false)

  @@unique([staffId, dayOfWeek])
}

model StaffException {
  id        String       @id @default(cuid())

  staffId   String
  staff     StaffMember @relation(fields: [staffId], references: [id], onDelete: Cascade)

  date      DateTime     @db.Date
  isClosed  Boolean      @default(true)

  startTime String?
  endTime   String?
  reason    String?

  @@unique([staffId, date])
}

/* =======================
   SERVICE
======================= */

model Service {
  id                  String                       @id @default(cuid())
  name                String
  description         String?                      @db.Text

  price               Int
  duration            Int
  capacity            Int                          @default(1)

  depositRequired     Boolean                      @default(false)
  depositAmount       Int?

  isActive            Boolean                      @default(true)

  businessId          String
  business            Business                    @relation(fields: [businessId], references: [id], onDelete: Cascade)

  staff               ServiceStaff[]
  bookings            Booking[]

  staffChangeRequests StaffServiceChangeRequest[]
}

model ServiceStaff {
  id            String       @id @default(cuid())

  serviceId     String
  service       Service     @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  staffId       String
  staff         StaffMember @relation(fields: [staffId], references: [id], onDelete: Cascade)

  overridePrice Int?

  @@unique([serviceId, staffId])
}

/* =======================
   BOOKING & PAYMENT
======================= */

model Booking {
  id            String         @id @default(cuid())

  businessId    String
  business      Business      @relation(fields: [businessId], references: [id])

  customerId    String
  customer      User          @relation(fields: [customerId], references: [id])

  serviceId     String
  service       Service       @relation(fields: [serviceId], references: [id])

  staffId       String
  staff         StaffMember   @relation(fields: [staffId], references: [id])

  startTime     DateTime
  endTime       DateTime

  status        BookingStatus  @default(PENDING_CONFIRMATION)
  totalPrice    Int

  customerNotes String?
  internalNotes String?

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  deletedAt     DateTime?

  createdById   String?
  createdBy     User?         @relation("BookingCreatedBy", fields: [createdById], references: [id])

  payments      Payment[]
}

model Payment {
  id            String         @id @default(cuid())

  businessId    String
  business      Business      @relation(fields: [businessId], references: [id])

  bookingId     String         @unique
  booking       Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  method        PaymentMethod  @default(ONLINE)
  amount        Int
  status        PaymentStatus  @default(PENDING)

  authority     String?
  refId         String?
  gatewayName   String?

  verifiedById  String?
  verifiedBy    User?         @relation("PaymentVerifiedBy", fields: [verifiedById], references: [id])
  verifiedAt    DateTime?

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  ledgerEntries LedgerEntry[]
  commission    Commission?
}

model Commission {
  id            String    @id @default(cuid())

  paymentId     String    @unique
  payment       Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  grossAmount   Int
  platformFee   Int
  businessShare Int
  taxAmount     Int?

  createdAt     DateTime  @default(now())
}

/* =======================
   LEDGER & SETTLEMENT
======================= */

model LedgerEntry {
  id           String           @id @default(cuid())

  walletType   WalletType
  entryType    LedgerEntryType
  amount       Int

  paymentId    String?
  payment      Payment?        @relation(fields: [paymentId], references: [id])

  settlementId String?
  settlement   Settlement?     @relation(fields: [settlementId], references: [id])

  businessId   String?
  business     Business?       @relation(fields: [businessId], references: [id])

  createdAt    DateTime         @default(now())
}

model Settlement {
  id            String            @id @default(cuid())

  businessId    String
  business      Business         @relation(fields: [businessId], references: [id])

  amount        Int
  status        SettlementStatus  @default(PENDING)

  fromDate      DateTime
  toDate        DateTime

  paidAt        DateTime?
  createdAt     DateTime          @default(now())

  ledgerEntries LedgerEntry[]
}

/* =======================
   OTHERS
======================= */

model OtpCode {
  phone     String    @id
  codeHash  String
  expiresAt DateTime

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Favorite {
  id         String    @id @default(cuid())

  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt  DateTime  @default(now())

  @@unique([userId, businessId])
}

model StaffServiceChangeRequest {
  id                   String                    @id @default(cuid())

  staffId              String
  staff                StaffMember              @relation(fields: [staffId], references: [id])

  serviceId            String
  service              Service                  @relation(fields: [serviceId], references: [id])

  requestedPrice       Int?
  requestedActive      Boolean?
  requestedName        String?
  requestedDescription String?                   @db.Text
  requestedDuration    Int?
  status               StaffServiceChangeStatus  @default(PENDING)
  rejectionReason      String?

  createdAt            DateTime                  @default(now())
  reviewedAt           DateTime?
}
