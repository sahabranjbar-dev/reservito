generator client {
  provider = "prisma-client-js"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id       String  @id @default(uuid())
  fullName String?
  phone    String  @unique
  role     Role    @default(CUSTOMER)
  isActive Boolean @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  reservations        Reservation[]
  createdReservations Reservation[] @relation("CreatedBy")
  payments            Payment[]
  wallet              Wallet?
  auditLogs           AuditLog[]

  @@index([phone])
  @@index([role])
  @@index([isActive])
  @@index([deletedAt])
}

model Service {
  id       String  @id @default(uuid())
  title    String
  duration Int // minutes
  price    Int?
  isActive Boolean @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  reservations  Reservation[]
  workingHours  WorkingHour[]
  calendarRules CalendarRule[]

  @@index([isActive])
  @@index([deletedAt])
}

model WorkingHour {
  id        String @id @default(uuid())
  serviceId String

  weekday      Int // 0 = Sunday ... 6 = Saturday
  startTime    String // "09:00"
  endTime      String // "17:00"
  isActive     Boolean  @default(true)
  englishTitle String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([weekday])
}

enum CalendarRuleType {
  DAY_OFF // تعطیلی یک روز
  CUSTOM_DAY // تغییر ساعت یک روز
  RANGE_OFF // تعطیلی بازه
  RANGE_CUSTOM // تغییر ساعت بازه
}

model CalendarRule {
  id        String           @id @default(uuid())
  serviceId String
  type      CalendarRuleType

  startDate DateTime // تاریخ شروع (یا تاریخ روز برای DAY_OFF/CUSTOM_DAY)
  endDate   DateTime? // فقط برای RANGE_*
  startTime String? // فقط برای CUSTOM_*
  endTime   String? // فقط برای CUSTOM_*

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([type])
  @@index([startDate])
  @@index([endDate])
}

model Reservation {
  id String @id @default(uuid())

  userId    String
  serviceId String

  startAt DateTime
  endAt   DateTime

  status ReservationStatus @default(PENDING)
  source ReservationSource
  notes  String?

  createdById String?

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  canceledAt DateTime?

  user      User      @relation(fields: [userId], references: [id])
  service   Service   @relation(fields: [serviceId], references: [id])
  createdBy User?     @relation("CreatedBy", fields: [createdById], references: [id])
  payments  Payment[]

  @@index([userId])
  @@index([serviceId])
  @@index([startAt, endAt])
  @@index([status])
}

model Payment {
  id String @id @default(cuid())

  userId        String
  reservationId String?
  orderId       String?

  amount Decimal       @db.Decimal(10, 2)
  method PaymentMethod
  status PaymentStatus

  authority     String?
  refId         String?
  failureReason String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  paidAt    DateTime?

  user        User         @relation(fields: [userId], references: [id])
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model Wallet {
  id      String  @id @default(uuid())
  userId  String  @unique
  balance Decimal @default(0) @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model OtpCode {
  phone     String   @id
  codeHash  String
  expiresAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([expiresAt])
}

model AuditLog {
  id        String      @id @default(uuid())
  userId    String?
  action    AuditAction
  entity    String
  entityId  String?
  ip        String?
  userAgent String?
  metadata  Json?

  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([entity])
  @@index([createdAt])
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  PAID
  DONE
  CANCELED
}

enum ReservationSource {
  ONLINE
  WALK_IN
  PHONE
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum PaymentMethod {
  ONLINE
  CASH
  WALLET
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  PAYMENT
}

enum Role {
  ADMIN
  SECRETARY
  CUSTOMER
}
